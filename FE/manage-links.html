<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cluq - Quản lý liên kết</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for animations and specific properties not in Tailwind */
        body {
            background-image: radial-gradient(circle at top left, rgba(0, 188, 212, 0.1) 0%, transparent 40%),
                radial-gradient(circle at bottom right, rgba(0, 188, 212, 0.1) 0%, transparent 40%);
            background-size: 100% 100%;
            background-repeat: no-repeat;
            animation: backgroundShift 20s infinite alternate;
        }

        @keyframes backgroundShift {
            0% {
                background-position: 0% 0%, 100% 100%;
            }

            100% {
                background-position: 100% 100%, 0% 0%;
            }
        }

        .backdrop-blur-md {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .animate-fadeIn {
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
            will-change: transform, opacity;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .shine-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.4s ease-out;
            will-change: transform;
        }

        .shine-effect:hover::before {
            left: 100%;
        }

        /* Responsive Optimization for Mobile Performance */
        @media (max-width: 767px) {
            body {
                animation: none;
                /* Disable backgroundShift on mobile */
                background-image: none;
                /* Remove radial gradients for body */
            }

            /* Adjust font sizes and padding for better mobile readability and less clutter */
            h1 {
                font-size: 3.5rem !important;
                /* Smaller on mobile */
            }

            p {
                font-size: 1.1rem !important;
                /* Smaller on mobile */
            }

            h2 {
                font-size: 2.5rem !important;
                /* Smaller on mobile */
            }

            input,
            button {
                font-size: 1rem !important;
                /* Smaller input/button text */
                padding: 12px 20px !important;
                /* Smaller padding */
            }

            .text-lg {
                /* For messageArea */
                font-size: 1rem !important;
            }

            .text-xl {
                /* For button text */
                font-size: 1.1rem !important;
            }

            .text-sm {
                /* For nav links */
                font-size: 0.85rem !important;
            }

            .text-base {
                /* For nav links */
                font-size: 0.9rem !important;
            }

            .text-4xl {
                /* For logo */
                font-size: 2.5rem !important;
            }

            .text-5xl {
                /* For logo */
                font-size: 3rem !important;
            }

            /* Make table responsive on small screens */
            .table-container {
                overflow-x: auto;
                /* Allows horizontal scrolling for table */
                -webkit-overflow-scrolling: touch;
                /* Smooth scrolling on iOS */
            }

            table {
                min-width: 600px;
                /* Ensure table content is not too cramped */
            }

            .shortlink-button {
                padding: 6px 10px !important;
                /* Smaller padding for mobile buttons */
                font-size: 0.8rem !important;
                /* Smaller font for mobile buttons */
            }

            #sidebar {
                width: 80%;
                /* Take up 80% width on small screens */
                max-width: 320px;
                /* Max width for mobile sidebar */
            }
        }
    </style>
</head>

<body
    class="font-inter antialiased bg-[#0D1117] text-[#C9D1D9] leading-relaxed overflow-x-hidden min-h-screen flex flex-col">
    <header
        class="bg-[#161B22] bg-opacity-80 backdrop-blur-md py-3 shadow-2xl flex justify-between items-center sticky top-0 z-50 border-b border-teal-600/20">
        <div class="container mx-auto px-4 sm:px-6 flex justify-between items-center w-full">
            <a href="http://127.0.0.1:5500/FE/dashboard.html" class="text-4xl sm:text-5xl font-extrabold text-teal-400 no-underline inline-block transition-all duration-300 ease-in-out ml-2 sm:ml-4
                      hover:text-teal-300 drop-shadow-lg hover:drop-shadow-xl z-[1001]">
                Cluq
            </a>
            <nav class="mr-2 sm:mr-4 flex items-center">
                <button id="sidebarToggleBtn"
                    class="text-gray-100 ml-4 p-2 rounded-md hover:bg-teal-700/30 transition-colors duration-200 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <button id="logoutButton" class="text-sm sm:text-base text-gray-100 no-underline font-semibold ml-4 sm:ml-6 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg sm:rounded-xl transition-all duration-300 ease-in-out relative overflow-hidden shine-effect
                          hover:bg-red-700 hover:text-white hover:translate-y-[-2px] z-[1001]">
                    Đăng xuất
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-grow py-10 px-4 animate-fadeIn">
        <div class="container mx-auto max-w-6xl">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-8 text-teal-400 drop-shadow-md">Quản lý các
                liên kết của bạn</h1>
            <p class="text-lg text-gray-300 text-center mb-10">Xem và quản lý tất cả các liên kết rút gọn bạn đã tạo.
            </p>

            <div id="loadingIndicator" class="text-center text-teal-400 text-xl font-semibold my-10">Đang tải liên
                kết...</div>
            <div id="errorMessage" class="text-center text-red-500 text-lg font-semibold my-10 hidden"></div>
            <div id="noLinksMessage" class="text-center text-gray-400 text-lg my-10 hidden">Bạn chưa tạo shortlink nào.
            </div>

            <div id="linksTableContainer"
                class="table-container bg-[#161B22] rounded-xl shadow-2xl border border-teal-600/30 p-4 hidden">
                <table class="min-w-full divide-y divide-teal-700/50">
                    <thead class="bg-[#0D1117]">
                        <tr>
                            <th scope="col"
                                class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tl-lg sm:px-6">
                                ID
                            </th>
                            <th scope="col"
                                class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sm:px-6">
                                Liên kết gốc
                            </th>
                            <th scope="col"
                                class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sm:px-6">
                                Liên kết rút gọn
                            </th>
                            <th scope="col"
                                class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sm:px-6">
                                Tạo lúc
                            </th>
                            <th scope="col"
                                class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider rounded-tr-lg sm:px-6">
                                Cập nhật lúc
                            </th>
                        </tr>
                    </thead>
                    <tbody id="linksTableBody" class="bg-[#161B22] divide-y divide-teal-700/30">
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="sidebar"
        class="fixed top-0 right-0 h-full w-64 bg-[#161B22] shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-[1002]">
        <div class="p-6">
            <h3 class="text-xl font-bold text-teal-400 mb-6 border-b border-teal-700/50 pb-3">Menu</h3>
            <nav>
                <ul>
                    <li class="mb-4">
                        <a href="http://127.0.0.1:5500/FE/dashboard.html"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7m7-7v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                                </path>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="http://127.0.0.1:5500/FE/manage-links.html"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2">
                                </path>
                            </svg>
                            Quản lý liên kết
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="http://127.0.0.1:5500/FE/my-account.html"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Tài khoản của tôi
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="http://127.0.0.1:5500/FE/my-account.html" id="walletLink"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                            Ví tiền: <span id="balanceAmount"> 0.00</span>
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="http://127.0.0.1:5500/FE/my-account.html"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.568.356 1.153-.133 1.065-2.572z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Cài đặt
                        </a>
                    </li>
                    <div id="adminMenuSection" class="hidden">
                        <li class="mb-4 border-t border-teal-700/50 pt-4 mt-4">
                            <h4 class="text-gray-400 text-sm font-semibold uppercase mb-2">Admin</h4>
                            <a href="http://127.0.0.1:5500/FE/manager-users.html"
                                class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h2a2 2 0 002-2V7.5L14.5 4H9a2 2 0 00-2 2v12a2 2 0 002 2h5M7 12h5m-5 4h5M9 4h6v6h-6V4z">
                                    </path>
                                </svg>
                                Quản lý người dùng
                            </a>
                        </li>
                    </div>
                </ul>
            </nav>
        </div>
    </div>
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[1001] hidden"></div>

    <footer
        class="bg-[#161B22] py-8 sm:py-10 text-center text-gray-400 text-sm sm:text-base border-t border-teal-600/10 shadow-inner shadow-gray-900/50">
        <div class="container mx-auto px-4 sm:px-5">
            <p>&copy; <span id="year"></span> Cluq. Mọi quyền được bảo lưu.</p>
            <script>
                document.getElementById("year").textContent = new Date().getFullYear();
            </script>
            <br>
            <p>Develope by <a href="https://github.com/shyhubb">Shyhub</a> </p>
        </div>
    </footer>

    <script>
        const PRIVATE_SHORT_LINK_API_V1_PATH = '/v1/user/link';
        const USER_API_V1_PATH = '/v1/user';
        const BASE_SHORT_URL_DOMAIN = 'http://localhost:8080';
        const WEB_CONSTANTS_BASE_SUCCESS = 'Thành công.';
        const WEB_CONSTANTS_DONT_HAVE_SHORTLINK_IN_SYSTEM = 'Bạn chưa tạo shortlink nào.';

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = 'http://127.0.0.1:5500/FE/login.html';
                return;
            }

            const logoutButton = document.getElementById('logoutButton');

            // Elements for displaying user links
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const noLinksMessage = document.getElementById('noLinksMessage');
            const linksTableContainer = document.getElementById('linksTableContainer');
            const linksTableBody = document.getElementById('linksTableBody');

            // Sidebar Elements
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const adminMenuSection = document.getElementById('adminMenuSection');

            // Event Listeners for Sidebar
            sidebarToggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('jwtToken');
                window.location.href = 'http://127.0.0.1:5500/FE/login.html';
            });

            // Function to fetch and display user links in the table
            async function fetchUserLinks() {
                loadingIndicator.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                noLinksMessage.classList.add('hidden');
                linksTableContainer.classList.add('hidden');
                linksTableBody.innerHTML = ''; // Clear previous data

                try {
                    const apiUrl = BASE_SHORT_URL_DOMAIN + PRIVATE_SHORT_LINK_API_V1_PATH + '/findall';
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` // Send JWT token
                        },
                    });

                    const data = await response.json();
                    console.log('User Links API Response Status:', response.status);
                    console.log('User Links API Response Message:', data.message);

                    if (response.ok && data.message === WEB_CONSTANTS_BASE_SUCCESS) {
                        if (data.data && data.data.length > 0) {
                            data.data.forEach(link => {
                                const row = document.createElement('tr');
                                row.classList.add('hover:bg-teal-900/20', 'transition-colors', 'duration-200');
                                row.innerHTML = `
                                    <td class="px-3 py-4 text-sm font-medium text-gray-200 whitespace-nowrap sm:px-6">${link.id}</td>
                                    <td class="px-3 py-4 text-sm font-medium text-gray-200 whitespace-nowrap sm:px-6">${link.originalLink}</td>
                                    <td class="px-3 py-4 text-sm text-center whitespace-nowrap sm:px-6">
                                        <a href="${link.shortLink}" target="_blank"
                                           class="shortlink-button inline-block bg-teal-600 text-white px-3 py-1 rounded-md text-xs font-semibold
                                                  hover:bg-teal-500 transition-colors duration-200 whitespace-nowrap">
                                            ${link.shortLink}
                                        </a>
                                    </td>
                                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-400 sm:px-6">${new Date(link.createAt).toLocaleString()}</td>
                                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-400 sm:px-6">${new Date(link.updateAt).toLocaleString()}</td>
                                `;
                                linksTableBody.appendChild(row);
                            });
                            linksTableContainer.classList.remove('hidden');
                        } else {
                            noLinksMessage.classList.remove('hidden');
                        }
                    } else {
                        let msg = data.message || 'Không thể tải liên kết của bạn. Vui lòng thử lại.';
                        if (response.status === 401 || response.status === 403) {
                            msg = 'Phiên đăng nhập của bạn đã hết hạn hoặc không hợp lệ. Vui lòng đăng nhập lại.';
                            localStorage.removeItem('jwtToken'); // Clear invalid token
                            setTimeout(() => { window.location.href = 'http://127.0.0.1:5500/FE/login.html'; }, 2000); // Redirect after message
                        }
                        errorMessage.textContent = msg;
                        errorMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Lỗi fetch user links:', error);
                    errorMessage.textContent = 'Không thể kết nối đến máy chủ để tải liên kết. Vui lòng kiểm tra kết nối mạng.';
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }

            // Function to check user role and display admin menu
            async function checkUserRoleAndPopulateUI() {
                try {
                    const apiUrl = BASE_SHORT_URL_DOMAIN + USER_API_V1_PATH + '/getprofile';
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                    });

                    const data = await response.json();
                    console.log('User Profile API Response Status:', response.status);
                    console.log('User Profile API Response Message:', data.message);

                    if (response.ok && data.message === WEB_CONSTANTS_BASE_SUCCESS && data.data) {
                        if (data.data.role === 'ADMIN') {
                            adminMenuSection.classList.remove('hidden');
                        } else {
                            adminMenuSection.classList.add('hidden');
                        }
                    } else {
                        adminMenuSection.classList.add('hidden');
                        if (response.status === 401 || response.status === 403) {
                            localStorage.removeItem('jwtToken');
                            setTimeout(() => { window.location.href = 'http://127.0.0.1:5500/FE/login.html'; }, 2000);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching user role:', error);
                    adminMenuSection.classList.add('hidden');
                }
            }

            // Fetch links and check user role when the page loads
            fetchUserLinks();
            checkUserRoleAndPopulateUI();
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkQ - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for animations and specific properties not in Tailwind */
        body {
            background-image: radial-gradient(circle at top left, rgba(0, 188, 212, 0.1) 0%, transparent 40%),
                radial-gradient(circle at bottom right, rgba(0, 188, 212, 0.1) 0%, transparent 40%);
            background-size: 100% 100%;
            background-repeat: no-repeat;
            animation: backgroundShift 20s infinite alternate;
        }

        @keyframes backgroundShift {
            0% {
                background-position: 0% 0%, 100% 100%;
            }

            100% {
                background-position: 100% 100%, 0% 0%;
            }
        }

        .backdrop-blur-md {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .animate-fadeIn {
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
            will-change: transform, opacity;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .shine-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.4s ease-out;
            will-change: transform;
        }

        .shine-effect:hover::before {
            left: 100%;
        }

        /* Responsive Optimization for Mobile Performance */
        @media (max-width: 767px) {
            body {
                animation: none;
                /* Disable backgroundShift on mobile */
                background-image: none;
                /* Remove radial gradients for body */
            }

            /* Adjust font sizes and padding for better mobile readability and less clutter */
            h1 {
                font-size: 3.5rem !important;
                /* Smaller on mobile */
            }

            p {
                font-size: 1.1rem !important;
                /* Smaller on mobile */
            }

            h2 {
                font-size: 2.5rem !important;
                /* Smaller on mobile */
            }

            input,
            button {
                font-size: 1rem !important;
                /* Smaller input/button text */
                padding: 12px 20px !important;
                /* Smaller padding */
            }

            .text-lg {
                /* For messageArea */
                font-size: 1rem !important;
            }

            .text-xl {
                /* For button text */
                font-size: 1.1rem !important;
            }

            .text-sm {
                /* For nav links */
                font-size: 0.85rem !important;
            }

            .text-base {
                /* For nav links */
                font-size: 0.9rem !important;
            }

            .text-4xl {
                /* For logo */
                font-size: 2.5rem !important;
            }

            .text-5xl {
                /* For logo */
                font-size: 3rem !important;
            }

            /* Make table responsive on small screens */
            .table-container {
                overflow-x: auto;
                /* Allows horizontal scrolling for table */
                -webkit-overflow-scrolling: touch;
                /* Smooth scrolling on iOS */
            }

            table {
                min-width: 600px;
                /* Ensure table content is not too cramped */
            }

            .shortlink-button {
                padding: 6px 10px !important;
                /* Smaller padding for mobile buttons */
                font-size: 0.8rem !important;
                /* Smaller font for mobile buttons */
            }

            #sidebar {
                width: 80%;
                /* Take up 80% width on small screens */
                max-width: 320px;
                /* Max width for mobile sidebar */
            }
        }
    </style>
</head>

<body
    class="font-inter antialiased bg-[#0D1117] text-[#C9D1D9] leading-relaxed overflow-x-hidden min-h-screen flex flex-col">
    <header
        class="bg-[#161B22] bg-opacity-80 backdrop-blur-md py-3 shadow-2xl flex justify-between items-center sticky top-0 z-50 border-b border-teal-600/20">
        <div class="container mx-auto px-4 sm:px-6 flex justify-between items-center w-full">
            <a href="http://127.0.0.1:5500/FE/dashboard.html" class="text-4xl sm:text-5xl font-extrabold text-teal-400 no-underline inline-block transition-all duration-300 ease-in-out ml-2 sm:ml-4
                      hover:text-teal-300 drop-shadow-lg hover:drop-shadow-xl z-[1001]">
                Cluq
            </a>
            <nav class="mr-2 sm:mr-4 flex items-center">
                <button id="sidebarToggleBtn"
                    class="text-gray-100 ml-4 p-2 rounded-md hover:bg-teal-700/30 transition-colors duration-200 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <button id="logoutButton" class="text-sm sm:text-base text-gray-100 no-underline font-semibold ml-4 sm:ml-6 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg sm:rounded-xl transition-all duration-300 ease-in-out relative overflow-hidden shine-effect
                          hover:bg-red-700 hover:text-white hover:translate-y-[-2px] z-[1001]">
                    Đăng xuất
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-grow py-10 px-4 animate-fadeIn">
        <div class="container mx-auto max-w-6xl">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-center mb-8 text-teal-400 drop-shadow-md">Cluq Panel
            </h1>
            <p class="text-lg text-gray-300 text-center mb-10">Tạo các liên kết rút gọn của bạn tại đây.</p>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                <div class="bg-[#161B22] p-8 rounded-xl shadow-2xl border border-teal-600/30">
                    <h2 class="text-3xl font-bold text-teal-300 mb-6">Tạo liên kết rút gọn ngẫu nhiên</h2>
                    <form id="randomShortenForm" class="flex flex-col gap-4">
                        <div>
                            <label for="randomOriginalLinkInput"
                                class="block text-gray-300 text-base font-semibold mb-2">URL gốc</label>
                            <input type="url" id="randomOriginalLinkInput" placeholder="Nhập URL dài của bạn" required
                                class="w-full p-3 border-2 border-teal-500 rounded-lg bg-[#0D1117] text-gray-100 text-base transition-all duration-300 ease-in-out shadow-inner shadow-gray-900/50
                                          placeholder:text-gray-500 focus:outline-none focus:border-teal-400 focus:shadow-lg focus:shadow-teal-500/40 focus:bg-[#1A212B]">
                        </div>
                        <button type="submit" id="randomShortenButton"
                            class="bg-teal-500 text-gray-900 px-6 py-3 text-lg font-bold rounded-lg cursor-pointer transition-all duration-300 ease-in-out w-full shadow-lg shadow-teal-500/40 relative overflow-hidden shine-effect
                                       hover:bg-teal-400 hover:translate-y-[-2px] hover:shadow-xl hover:hover:shadow-teal-500/60">
                            Rút gọn ngẫu nhiên
                        </button>
                    </form>
                    <div id="randomResultArea"
                        class="mt-6 p-4 bg-[#0D1117] rounded-lg border border-teal-600/30 text-gray-100 text-base break-words hidden">
                        <p class="mb-2 text-gray-400 font-semibold">URL rút gọn của bạn:</p>
                        <a id="randomShortLinkOutput" href="#" target="_blank"
                            class="text-teal-400 no-underline font-bold transition-colors duration-300 block hover:text-teal-300 hover:underline"></a>
                        <button id="copyRandomButton" class="mt-3 bg-teal-500 text-gray-900 px-4 py-2 text-sm font-semibold rounded-md cursor-pointer transition-all duration-300 shadow-md shadow-teal-500/30
                                                     hover:bg-teal-400 hover:translate-y-[-1px]">
                            Sao chép
                        </button>
                    </div>
                    <div id="randomErrorMessage" class="text-red-500 mt-4 text-base font-semibold hidden"></div>
                </div>

                <div class="bg-[#161B22] p-8 rounded-xl shadow-2xl border border-teal-600/30">
                    <h2 class="text-3xl font-bold text-teal-300 mb-6">Tạo liên kết rút gọn tùy chỉnh</h2>
                    <form id="customShortenForm" class="flex flex-col gap-4">
                        <div>
                            <label for="customOriginalLinkInput"
                                class="block text-gray-300 text-base font-semibold mb-2">URL gốc</label>
                            <input type="url" id="customOriginalLinkInput" placeholder="Nhập URL dài của bạn" required
                                class="w-full p-3 border-2 border-teal-500 rounded-lg bg-[#0D1117] text-gray-100 text-base transition-all duration-300 ease-in-out shadow-inner shadow-gray-900/50
                                          placeholder:text-gray-500 focus:outline-none focus:border-teal-400 focus:shadow-lg focus:shadow-teal-500/40 focus:bg-[#1A212B]">
                        </div>
                        <div>
                            <label for="customShortCodeInput"
                                class="block text-gray-300 text-base font-semibold mb-2">Mã rút gọn tùy chỉnh (ví dụ:
                                mylink)</label>
                            <input type="text" id="customShortCodeInput"
                                placeholder="Chỉ chữ cái và số, tối thiểu 6 ký tự" required
                                class="w-full p-3 border-2 border-teal-500 rounded-lg bg-[#0D1117] text-gray-100 text-base transition-all duration-300 ease-in-out shadow-inner shadow-gray-900/50
                                          placeholder:text-gray-500 focus:outline-none focus:border-teal-400 focus:shadow-lg focus:shadow-teal-500/40 focus:bg-[#1A212B]">
                        </div>
                        <button type="submit" id="customShortenButton"
                            class="bg-teal-500 text-gray-900 px-6 py-3 text-lg font-bold rounded-lg cursor-pointer transition-all duration-300 ease-in-out w-full shadow-lg shadow-teal-500/40 relative overflow-hidden shine-effect
                                       hover:bg-teal-400 hover:translate-y-[-2px] hover:shadow-xl hover:hover:shadow-teal-500/60">
                            Rút gọn tùy chỉnh
                        </button>
                    </form>
                    <div id="customResultArea"
                        class="mt-6 p-4 bg-[#0D1117] rounded-lg border border-teal-600/30 text-gray-100 text-base break-words hidden">
                        <p class="mb-2 text-gray-400 font-semibold">URL rút gọn của bạn:</p>
                        <a id="customShortLinkOutput" href="#" target="_blank"
                            class="text-teal-400 no-underline font-bold transition-colors duration-300 block hover:text-teal-300 hover:underline"></a>
                        <button id="copyCustomButton" class="mt-3 bg-teal-500 text-gray-900 px-4 py-2 text-sm font-semibold rounded-md cursor-pointer transition-all duration-300 shadow-md shadow-teal-500/30
                                                     hover:bg-teal-400 hover:translate-y-[-1px]">
                            Sao chép
                        </button>
                    </div>
                    <div id="customErrorMessage" class="text-red-500 mt-4 text-base font-semibold hidden"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="sidebar"
        class="fixed top-0 right-0 h-full w-64 bg-[#161B22] shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-[1002]">
        <div class="p-6">
            <h3 class="text-xl font-bold text-teal-400 mb-6 border-b border-teal-700/50 pb-3">Menu</h3>
            <nav>
                <ul>
                    <li class="mb-4">
                        <a href="http://127.0.0.1:5500/FE/dashboard.html"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7m7-7v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                                </path>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="http://127.0.0.1:5500/FE/manage-links.html"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2">
                                </path>
                            </svg>
                            Quản lý liên kết
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="http://127.0.0.1:5500/FE/my-account.html"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Tài khoản của tôi
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="http://127.0.0.1:5500/FE/my-account.html" id="walletLink"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                            Ví tiền: <span id="balanceAmount"> 0.00</span>
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="#"
                            class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.568.356 1.153-.133 1.065-2.572z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Cài đặt
                        </a>
                    </li>
                    <div id="adminMenuSection" class="hidden">
                        <li class="mb-4 border-t border-teal-700/50 pt-4 mt-4">
                            <h4 class="text-gray-400 text-sm font-semibold uppercase mb-2">Admin</h4>
                            <a href="manager-users.html"
                                class="flex items-center text-gray-200 hover:text-teal-400 text-lg font-semibold transition-colors duration-200">
                                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h2a2 2 0 002-2V7.5L14.5 4H9a2 2 0 00-2 2v12a2 2 0 002 2h5M7 12h5m-5 4h5M9 4h6v6h-6V4z">
                                    </path>
                                </svg>
                                Quản lý người dùng
                            </a>
                        </li>
                    </div>
                </ul>
            </nav>
        </div>
    </div>
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[1001] hidden"></div>

    <footer
        class="bg-[#161B22] py-8 sm:py-10 text-center text-gray-400 text-sm sm:text-base border-t border-teal-600/10 shadow-inner shadow-gray-900/50">
        <div class="container mx-auto px-4 sm:px-5">
            <p>&copy; <span id="year"></span> Cluq. Mọi quyền được bảo lưu.</p>
            <script>
                document.getElementById("year").textContent = new Date().getFullYear();
            </script>
            <br>
            <p>Develope by <a href="https://github.com/shyhubb">Shyhub</a> </p>
        </div>
    </footer>

    <script>
        const PRIVATE_SHORT_LINK_API_V1_PATH = '/v1/user/link';
        const USER_API_V1_PATH = '/v1/user';
        const BASE_SHORT_URL_DOMAIN = 'http://localhost:8080';
        const WEB_CONSTANTS_BASE_SUCCESS = 'Thành công.';
        const WEB_CONSTANTS_SHORT_CODE_LENGTH_ERROR = 'Mã rút gọn phải có ít nhất 6 ký tự.';
        const WEB_CONSTANTS_SHORT_CODE_INVALID_CHARACTERS_ERROR = 'Mã custom shortlink không hợp lệ, chỉ chấp nhận chữ cái và số.';
        const WEB_CONSTANTS_SHORT_CODE_EXISTS_ERROR = 'Mã rút gọn đã tồn tại.';
        const WEB_CONSTANTS_CREATE_LINK_LIMIT = 'Bạn đã đạt giới hạn tạo Shortlink.';
        const WALLET_PAGE_URL = 'http://127.0.0.1:5500/FE/my-account.html';

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = 'http://127.0.0.1:5500/FE/login.html';
                return;
            }

            const logoutButton = document.getElementById('logoutButton');

            // Elements for Random Shortlink Form
            const randomShortenForm = document.getElementById('randomShortenForm');
            const randomOriginalLinkInput = document.getElementById('randomOriginalLinkInput');
            const randomShortenButton = document.getElementById('randomShortenButton');
            const randomResultArea = document.getElementById('randomResultArea');
            const randomShortLinkOutput = document.getElementById('randomShortLinkOutput');
            const copyRandomButton = document.getElementById('copyRandomButton');
            const randomErrorMessage = document.getElementById('randomErrorMessage');

            // Elements for Custom Shortlink Form
            const customShortenForm = document.getElementById('customShortenForm');
            const customOriginalLinkInput = document.getElementById('customOriginalLinkInput');
            const customShortCodeInput = document.getElementById('customShortCodeInput');
            const customShortenButton = document.getElementById('customShortenButton');
            const customResultArea = document.getElementById('customResultArea');
            const customShortLinkOutput = document.getElementById('customShortLinkOutput');
            const copyCustomButton = document.getElementById('copyCustomButton');
            const customErrorMessage = document.getElementById('customErrorMessage');

            // Sidebar Elements
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const adminMenuSection = document.getElementById('adminMenuSection');

            // Balance display elements - these are now in the sidebar
            const balanceAmountSpan = document.getElementById('balanceAmount');
            const walletLink = document.getElementById('walletLink');

            // Event Listeners for Sidebar
            sidebarToggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('jwtToken');
                window.location.href = 'http://127.0.0.1:5500/FE/login.html';
            });

            // Add click listener for wallet link (though the href already handles navigation)
            if (walletLink) {
                walletLink.addEventListener('click', (event) => {
                    // event.preventDefault(); // Prevent default if you want to do something else before navigating
                    window.location.href = WALLET_PAGE_URL;
                });
            }

            // Helper function to display messages for creation forms
            function displayFormMessage(messageElement, message, isError) {
                messageElement.textContent = message;
                messageElement.classList.remove('hidden', 'text-green-500', 'text-red-500');
                if (isError) {
                    messageElement.classList.add('text-red-500');
                } else {
                    messageElement.classList.add('text-green-500');
                }
            }

            // Helper for URL validation
            function isValidUrl(string) {
                try {
                    const url = new URL(string);
                    return ['http:', 'https:'].includes(url.protocol);
                } catch (_) {
                    return false;
                }
            }

            // Handle Random Shortlink Form Submission
            randomShortenForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const originalLink = randomOriginalLinkInput.value.trim();

                randomResultArea.classList.add('hidden');
                randomErrorMessage.classList.add('hidden');

                if (!originalLink) {
                    displayFormMessage(randomErrorMessage, 'Vui lòng nhập URL gốc.', true);
                    return;
                }
                if (!isValidUrl(originalLink)) {
                    displayFormMessage(randomErrorMessage, 'URL không hợp lệ. Vui lòng nhập URL bắt đầu bằng http:// hoặc https://', true);
                    return;
                }

                randomShortenButton.textContent = 'Đang rút gọn...';
                randomShortenButton.disabled = true;

                try {
                    const apiUrl = BASE_SHORT_URL_DOMAIN + PRIVATE_SHORT_LINK_API_V1_PATH + '/create/random';
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ originalLink: originalLink }),
                    });

                    const data = await response.json();
                    console.log('Random Shortlink API Response Status:', response.status); // Optimized logging
                    console.log('Random Shortlink API Response Message:', data.message); // Optimized logging

                    if (response.ok && data.message === WEB_CONSTANTS_BASE_SUCCESS) {
                        if (data.data && data.data.shortLink) {
                            randomShortLinkOutput.href = data.data.shortLink;
                            randomShortLinkOutput.textContent = data.data.shortLink;
                            randomResultArea.classList.remove('hidden');
                            displayFormMessage(randomErrorMessage, '', false); // Clear error
                            randomOriginalLinkInput.value = ''; // Clear input
                            // No need to call fetchUserLinks() here as it's moved
                        } else {
                            displayFormMessage(randomErrorMessage, 'Phản hồi API không hợp lệ: Thiếu dữ liệu shortLink.', true);
                        }
                    } else {
                        let msg = data.message || 'Đã xảy ra lỗi không xác định khi tạo liên kết ngẫu nhiên.';
                        if (response.status === 429) {
                            msg = WEB_CONSTANTS_CREATE_LINK_LIMIT;
                        } else if (response.status === 401 || response.status === 403) {
                            msg = 'Phiên đăng nhập của bạn đã hết hạn hoặc không hợp lệ. Vui lòng đăng nhập lại.';
                            localStorage.removeItem('jwtToken');
                            setTimeout(() => { window.location.href = 'http://127.0.0.1:5500/FE/login.html'; }, 2000);
                        }
                        displayFormMessage(randomErrorMessage, msg, true);
                    }
                } catch (error) {
                    console.error('Lỗi fetch random shortlink:', error);
                    displayFormMessage(randomErrorMessage, 'Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối mạng.', true);
                } finally {
                    randomShortenButton.textContent = 'Rút gọn ngẫu nhiên';
                    randomShortenButton.disabled = false;
                }
            });

            // Handle Custom Shortlink Form Submission
            customShortenForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const originalLink = customOriginalLinkInput.value.trim();
                const customShortCode = customShortCodeInput.value.trim();

                customResultArea.classList.add('hidden');
                customErrorMessage.classList.add('hidden');

                if (!originalLink || !customShortCode) {
                    displayFormMessage(customErrorMessage, 'Vui lòng nhập đầy đủ URL gốc và mã rút gọn tùy chỉnh.', true);
                    return;
                }
                if (!isValidUrl(originalLink)) {
                    displayFormMessage(customErrorMessage, 'URL gốc không hợp lệ. Vui lòng nhập URL bắt đầu bằng http:// hoặc https://', true);
                    return;
                }
                if (customShortCode.length < 6) {
                    displayFormMessage(customErrorMessage, WEB_CONSTANTS_SHORT_CODE_LENGTH_ERROR, true);
                    return;
                }
                if (!/^[a-zA-Z0-9]+$/.test(customShortCode)) {
                    displayFormMessage(customErrorMessage, WEB_CONSTANTS_SHORT_CODE_INVALID_CHARACTERS_ERROR, true);
                    return;
                }

                customShortenButton.textContent = 'Đang rút gọn...';
                customShortenButton.disabled = true;

                try {
                    const apiUrl = BASE_SHORT_URL_DOMAIN + PRIVATE_SHORT_LINK_API_V1_PATH + '/create/custom';
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ originalLink: originalLink, customShortCode: customShortCode }),
                    });

                    const data = await response.json();
                    console.log('Custom Shortlink API Response Status:', response.status); // Optimized logging
                    console.log('Custom Shortlink API Response Message:', data.message); // Optimized logging

                    if (response.ok && data.message === WEB_CONSTANTS_BASE_SUCCESS) {
                        if (data.data && data.data.shortLink) {
                            customShortLinkOutput.href = data.data.shortLink;
                            customShortLinkOutput.textContent = data.data.shortLink;
                            customResultArea.classList.remove('hidden');
                            displayFormMessage(customErrorMessage, '', false); // Clear error
                            customOriginalLinkInput.value = ''; // Clear input
                            customShortCodeInput.value = ''; // Clear input
                            // No need to call fetchUserLinks() here as it's moved
                        } else {
                            displayFormMessage(customErrorMessage, 'Phản hồi API không hợp lệ: Thiếu dữ liệu shortLink.', true);
                        }
                    } else {
                        let msg = data.message || 'Đã xảy ra lỗi không xác định khi tạo liên kết tùy chỉnh.';
                        if (response.status === 429) {
                            msg = WEB_CONSTANTS_CREATE_LINK_LIMIT;
                        } else if (response.status === 400 && data.message === WEB_CONSTANTS_SHORT_CODE_EXISTS_ERROR) {
                            msg = WEB_CONSTANTS_SHORT_CODE_EXISTS_ERROR;
                        } else if (response.status === 401 || response.status === 403) {
                            msg = 'Phiên đăng nhập của bạn đã hết hạn hoặc không hợp lệ. Vui lòng đăng nhập lại.';
                            localStorage.removeItem('jwtToken');
                            setTimeout(() => { window.location.href = 'http://127.0.0.1:5500/FE/login.html'; }, 2000);
                        }
                        displayFormMessage(customErrorMessage, msg, true);
                    }
                } catch (error) {
                    console.error('Lỗi fetch custom shortlink:', error);
                    displayFormMessage(customErrorMessage, 'Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối mạng.', true);
                } finally {
                    customShortenButton.textContent = 'Rút gọn tùy chỉnh';
                    customShortenButton.disabled = false;
                }
            });

            // Copy to clipboard function
            function copyToClipboard(textToCopy, buttonElement) {
                console.log('Copy button clicked. Attempting to copy:', textToCopy);
                if (textToCopy) {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            buttonElement.textContent = 'Đã sao chép!';
                            setTimeout(() => {
                                buttonElement.textContent = 'Sao chép';
                            }, 2000);
                        }).catch(err => {
                            console.error('Không thể sao chép bằng Clipboard API:', err);
                            fallbackCopyTextToClipboard(textToCopy, buttonElement);
                        });
                    } else {
                        fallbackCopyTextToClipboard(textToCopy, buttonElement);
                    }
                }
            }

            function fallbackCopyTextToClipboard(text, buttonElement) {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = text;
                tempTextArea.style.position = 'fixed';
                tempTextArea.style.bottom = '0';
                tempTextArea.style.left = '0';
                document.body.appendChild(tempTextArea);
                tempTextArea.focus();
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    buttonElement.textContent = 'Đã sao chép!';
                    setTimeout(() => {
                        buttonElement.textContent = 'Sao chép';
                    }, 2000);
                } catch (err) {
                    console.error('Không thể sao chép bằng execCommand:', err);
                    alert('Xin lỗi, không thể sao chép tự động. Vui lòng sao chép thủ công: ' + text);
                } finally {
                    document.body.removeChild(tempTextArea);
                }
            }

            copyRandomButton.addEventListener('click', () => copyToClipboard(randomShortLinkOutput.textContent, copyRandomButton));
            copyCustomButton.addEventListener('click', () => copyToClipboard(customShortLinkOutput.textContent, copyCustomButton));


            // Function to check user role and display admin menu and update balance
            async function checkUserRoleAndPopulateUI() {
                try {
                    const apiUrl = BASE_SHORT_URL_DOMAIN + USER_API_V1_PATH + '/getprofile';
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                    });

                    const data = await response.json();
                    console.log('User Profile API Response Status:', response.status); // Optimized logging
                    console.log('User Profile API Response Message:', data.message); // Optimized logging

                    if (response.ok && data.message === WEB_CONSTANTS_BASE_SUCCESS && data.data) {
                        // Update balance display
                        if (balanceAmountSpan && data.data.balance !== undefined && data.data.balance !== null) {
                            // Display balance formatted as USD currency, removing .00 for whole numbers
                            balanceAmountSpan.textContent = parseFloat(data.data.balance).toLocaleString('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 });
                        }

                        if (data.data.role === 'ADMIN') {
                            adminMenuSection.classList.remove('hidden');
                        } else {
                            adminMenuSection.classList.add('hidden');
                        }
                    } else {
                        if (balanceAmountSpan) {
                            balanceAmountSpan.textContent = 'N/A';
                        }
                        adminMenuSection.classList.add('hidden');
                        if (response.status === 401 || response.status === 403) {
                            localStorage.removeItem('jwtToken');
                            setTimeout(() => { window.location.href = 'http://127.0.0.1:5500/FE/login.html'; }, 2000);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching user role and balance:', error);
                    if (balanceAmountSpan) {
                        balanceAmountSpan.textContent = 'Lỗi';
                    }
                    adminMenuSection.classList.add('hidden');
                }
            }


            // Check user role and balance when the page loads
            checkUserRoleAndPopulateUI();
        });
    </script>
</body>

</html>